# 后端非紧急优化问题清单

> **文档说明**：本文档记录了当前后端代码中存在的非功能性问题，包括性能优化、代码质量、缓存策略等。这些问题不会影响系统的基本可用性，可在系统稳定运行后逐步优化。
> 
> **优先级**：低 | **影响**：系统性能与可维护性 | **修复时机**：系统上线稳定后

---

## 一、性能优化类问题

### 1.1 N+1查询问题
**问题描述**：多处存在循环查询数据库的情况，如查询员工列表时，每个员工都要单独查询部门信息。

**影响范围**：
- `CompanyServiceImpl.getCompanyList()`
- `EmployeeServiceImpl.queryEmployeeList()`
- `MissionServiceImpl.queryMissionList()`
- 所有统计接口

**当前影响**：数据量大时响应慢，但功能可用

**优化方案**：
- 使用MyBatis-Plus的`selectMaps`批量查询
- 使用`@OneToMany`和`@ManyToOne`注解实现关联查询
- 关键接口添加Redis缓存

**预期收益**：查询性能提升50-80%

---

### 1.2 缓存机制缺失
**问题描述**：权限查询、配置查询等高频操作每次都访问数据库

**影响范围**：
- `EmployeeServiceImpl.getEmpPermission()`
- `CompanyServiceImpl.getCompanyPermission()`
- 所有字典数据查询

**当前影响**：数据库压力大，响应时间增加

**优化方案**：
```kotlin
// 添加Redis缓存
@Cacheable(value = ["userPermission"], key = "#employeeId")
fun getEmpPermission(employeeId: String): ResponseResult {
    // ...
}
```

**预期收益**：高频接口响应时间从100ms+降至10ms以内

---

### 1.3 大事务问题
**问题描述**：`addCompany`方法中一次性插入多条数据，事务时间过长

**影响范围**：公司创建、角色权限分配等

**当前影响**：并发高时锁表，影响其他操作

**优化方案**：
- 将非关键操作移出事务（如记录日志）
- 使用异步处理（@Async）处理后续操作
- 批量操作改为分批处理

**预期收益**：减少锁表时间，提升并发能力

---

### 1.4 分页参数未验证
**问题描述**：多处直接使用前端传入的pageSize，未做范围限制

**当前影响**：可能被恶意请求导致OOM

**优化方案**：
```kotlin
val pageSize = minOf(dto.pageSize ?: 10, 100)  // 最大限制100
```

---

### 1.5 递归查询性能问题
**问题描述**：`getNodeChildren`方法在内存中递归构建树结构

**当前影响**：数据量大时内存占用高

**优化方案**：
- 使用SQL递归查询（CTE）
- 使用迭代方式替代递归

---

## 二、代码质量类问题

### 2.1 重复代码
**问题描述**：统计逻辑（任务状态、员工统计）在多个服务中重复实现

**当前影响**：维护困难，修改一处需改多处

**优化方案**：
- 抽取公共统计服务`StatisticsService`
- 使用模板方法模式统一统计逻辑

---

### 2.2 魔法值硬编码
**问题描述**：状态值、类型判断等硬编码在代码中

```kotlin
if (dto.type == Database.TYPE_LOCAL){  // 好的实践
if (dto.parentId != ""){  // 坏的做法
```

**优化方案**：
- 使用常量或枚举替代魔法值
- 在DTO中使用`@NotBlank`等注解

---

### 2.3 异常处理不一致
**问题描述**：有的返回`fail`，有的返回`error`，有的抛出异常

**优化方案**：
- 统一异常处理规范
- 定义业务异常类`BusinessException`

---

### 2.4 日志记录缺失
**问题描述**：除操作记录外，无系统日志

**优化方案**：
- 添加SLF4J日志记录
- 关键操作记录INFO级别
- 异常记录ERROR级别

---

### 2.5 注释与TODO过多
**问题描述**：大量`TODO("还没做")`和过时注释

**优化方案**：
- 使用Issue追踪未完成工作
- 删除过时注释

---

## 三、安全加固类问题

### 3.1 密码策略未实施
**问题描述**：未验证密码强度

**当前状态**：功能可用（用户可注册），但安全性低

**加固方案**：
- 添加密码强度校验（8位以上，含大小写字母和数字）
- 密码加密存储（已使用BCrypt，✅）

---

### 3.2 登录失败次数未限制
**问题描述**：无防暴力破解机制

**加固方案**：
- 记录登录失败次数（Redis）
- 超过5次锁定账号30分钟

---

### 3.3 CSRF防护缺失
**问题描述**：未添加CSRF Token

**当前状态**：功能可用

**加固方案**：
- 添加Spring Security CSRF防护
- 或添加自定义Token验证

---

### 3.4 文件上传限制
**问题描述**：未限制文件大小和类型

**当前状态**：功能可用，但可能被滥用

**加固方案**：
```yaml
spring:
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 10MB
```

---

### 3.5 敏感信息未脱敏
**问题描述**：手机号、邮箱等可能直接返回给前端

**加固方案**：
- 添加脱敏注解`@Sensitive`
- 自定义Jackson序列化器

---

## 四、架构优化类问题

### 4.1 配置管理混乱
**问题描述**：配置分散在代码中

**优化方案**：
- 统一使用`@ConfigurationProperties`
- 建立配置中心（Nacos/Apollo）

---

### 4.2 API文档缺失
**问题描述**：无Swagger文档

**优化方案**：
- 集成SpringDoc OpenAPI
- 为所有接口添加注解说明

---

### 4.3 接口限流未实施
**问题描述**：无RateLimiter

**当前状态**：功能可用，但可能被刷

**优化方案**：
- 添加Sentinel或Resilience4j
- 关键接口限制QPS

---

### 4.4 异步处理缺失
**问题描述**：发送验证码、记录日志等操作同步执行

**优化方案**：
- 使用`@Async`异步处理
- 添加线程池配置

---

### 4.5 数据归档机制
**问题描述**：操作记录、聊天记录无归档策略

**优化方案**：
- 定时任务归档历史数据
- 冷热数据分离存储

---

## 五、开发体验类问题

### 5.1 无单元测试
**问题描述**：0测试覆盖率

**优化方案**：
- 添加JUnit 5单元测试
- 使用Mockito模拟依赖

---

### 5.2 无集成测试
**优化方案**：
- 添加API集成测试
- 使用Testcontainers测试数据库

---

### 5.3 构建速度慢
**优化方案**：
- 添加Gradle构建缓存
- 优化依赖管理

---

## 六、部署运维类问题

### 6.1 健康检查接口缺失
**优化方案**：
- 添加Spring Boot Actuator
- 配置健康检查端点

---

### 6.2 监控告警缺失
**优化方案**：
- 集成Micrometer + Prometheus
- 配置Grafana监控面板

---

### 6.3 日志收集未配置
**优化方案**：
- 配置ELK日志收集
- 或使用Loki + Grafana

---

## 七、优化实施路线图

### 第一阶段：系统稳定后（上线1个月内）
1. 添加日志记录
2. 抽取公共方法减少重复代码
3. 添加基础Swagger文档
4. 实施密码策略

### 第二阶段：性能优化（上线2-3个月）
1. 解决N+1查询问题
2. 添加Redis缓存
3. 优化大事务
4. 添加分页参数验证

### 第三阶段：安全加固（上线3-6个月）
1. 添加CSRF防护
2. 实施接口限流
3. 敏感信息脱敏
4. 登录失败次数限制

### 第四阶段：架构升级（持续进行）
1. 添加单元测试
2. 配置中心迁移
3. 监控告警完善
4. 数据归档实施

---

## 八、注意事项

⚠️ **重要提醒**：
1. 本文档中的问题不影响系统基本功能，请勿在系统上线前花费时间优化
2. 优先保证业务逻辑正确性和系统稳定性
3. 所有优化需经过充分测试后再上线
4. 建议建立技术债务看板，持续跟踪优化进度

---

**文档维护者**：开发团队
**最后更新**：2026-01-12
**文档版本**：v1.0
