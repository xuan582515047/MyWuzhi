# ğŸš¨ ä¿®å¤æ–¹æ¡ˆä¿®æ­£è¯´æ˜

> **ä¸¥é‡é”™è¯¯è­¦ç¤º**ï¼šä¹‹å‰çš„æ‰¹é‡æ’å…¥ä¿®å¤æ–¹æ¡ˆå­˜åœ¨ä¸¥é‡æŠ€æœ¯é”™è¯¯
> **ä¿®æ­£æ—¥æœŸ**ï¼š2026-01-12
> **ä¿®æ­£äºº**ï¼šAIåŠ©æ‰‹ï¼ˆè‡ªæˆ‘ä¿®æ­£ï¼‰

---

## é”™è¯¯å›é¡¾

### âŒ é”™è¯¯ä¿®å¤æ–¹æ¡ˆï¼ˆå·²æ’¤é”€ï¼‰

åœ¨`RoleServiceImpl.kt`ä¸­é”™è¯¯åœ°ä½¿ç”¨äº†ï¼š
```kotlin
// é”™è¯¯1ï¼šthis.saveBatch(linkList) - thisæ˜¯RoleServiceImplï¼Œåªèƒ½æ“ä½œRoleå®ä½“
// é”™è¯¯2ï¼šemployeeWithRoleMapper.saveBatch(linkList) - BaseMapperæ²¡æœ‰saveBatchæ–¹æ³•
```

### âœ… æ­£ç¡®ä¿®å¤æ–¹æ¡ˆï¼ˆå·²å®æ–½ï¼‰

**é—®é¢˜æ ¹æºåˆ†æ**ï¼š
1. **åˆ†å±‚æ¶æ„é”™è¯¯**ï¼šè¯•å›¾åœ¨RoleServiceä¸­ç›´æ¥æ“ä½œEmployeeWithRoleå’ŒRoleWithPermissionå®ä½“ï¼Œè¿åäº†DDDåˆ†å±‚åŸåˆ™
2. **APIè°ƒç”¨é”™è¯¯**ï¼šæ··æ·†äº†IService.saveBatch()å’ŒBaseMapper.insert()çš„ç”¨æ³•
3. **ä¾èµ–ç¼ºå¤±**ï¼šæ²¡æœ‰ä¸ºå…³è”è¡¨åˆ›å»ºå¯¹åº”çš„Serviceå±‚

---

## æ­£ç¡®ä¿®å¤æ­¥éª¤

### æ­¥éª¤1ï¼šåˆ›å»ºå…³è”è¡¨çš„Serviceå±‚

éµå¾ª**å•ä¸€èŒè´£åŸåˆ™ï¼ˆSRPï¼‰**ï¼Œæ¯ä¸ªå®ä½“åº”æœ‰ç‹¬ç«‹çš„Serviceï¼š

**æ–‡ä»¶1ï¼š`EmployeeWithRoleService.kt`**
```kotlin
package com.wuzhi.server.service_company.service

import com.baomidou.mybatisplus.extension.service.IService
import com.wuzhi.server.service_company.pojo.po.auth.EmployeeWithRole

interface EmployeeWithRoleService: IService<EmployeeWithRole> {
}
```

**æ–‡ä»¶2ï¼š`EmployeeWithRoleServiceImpl.kt`**
```kotlin
package com.wuzhi.server.service_company.service.impl

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl
import com.wuzhi.server.service_company.mapper.EmployeeWithRoleMapper
import com.wuzhi.server.service_company.pojo.po.auth.EmployeeWithRole
import com.wuzhi.server.service_company.service.EmployeeWithRoleService
import org.springframework.stereotype.Service

@Service
class EmployeeWithRoleServiceImpl: EmployeeWithRoleService, ServiceImpl<EmployeeWithRoleMapper, EmployeeWithRole>() {
}
```

**æ–‡ä»¶3ï¼š`RoleWithPermissionService.kt`**
```kotlin
package com.wuzhi.server.service_company.service

import com.baomidou.mybatisplus.extension.service.IService
import com.wuzhi.server.service_company.pojo.po.auth.RoleWithPermission

interface RoleWithPermissionService: IService<RoleWithPermission> {
}
```

**æ–‡ä»¶4ï¼š`RoleWithPermissionServiceImpl.kt`**
```kotlin
package com.wuzhi.server.service_company.service.impl

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl
import com.wuzhi.server.service_company.mapper.RoleWithPermissionMapper
import com.wuzhi.server.service_company.pojo.po.auth.RoleWithPermission
import com.wuzhi.server.service_company.service.RoleWithPermissionService
import org.springframework.stereotype.Service

@Service
class RoleWithPermissionServiceImpl: RoleWithPermissionService, ServiceImpl<RoleWithPermissionMapper, RoleWithPermission>() {
}
```

### æ­¥éª¤2ï¼šä¿®æ”¹RoleServiceImplï¼Œæ³¨å…¥æ­£ç¡®çš„Service

**å…³é”®ä¿®æ”¹ç‚¹**ï¼š
```kotlin
@Service
class RoleServiceImpl(
    private val employeeWithRoleMapper: EmployeeWithRoleMapper,  // ä¿ç•™ï¼Œç”¨äºdelete
    private val roleWithPermissionMapper: RoleWithPermissionMapper,  // ä¿ç•™ï¼Œç”¨äºdelete
    private val roleMapper: RoleMapper,
    @Lazy private val employeeService: EmployeeService,
    private val employeeWithRoleService: EmployeeWithRoleService,  // âœ… æ–°å¢
    private val roleWithPermissionService: RoleWithPermissionService  // âœ… æ–°å¢
): RoleService, ServiceImpl<RoleMapper, Role>() {
```

### æ­¥éª¤3ï¼šæ­£ç¡®ä½¿ç”¨saveBatchæ‰¹é‡æ’å…¥

**ä¿®å¤setRoleFromEmployeeæ–¹æ³•**ï¼š
```kotlin
@Transactional
override fun setRoleFromEmployee(dto: RoleEmployeeDTO): ResponseResult {
    // åˆ é™¤æ—§çš„è§’è‰²ç”¨æˆ·å…³è”ï¼ˆä½¿ç”¨Mapperåˆ é™¤ï¼‰
    val deleteWrapper = KtQueryWrapper(EmployeeWithRole::class.java)
        .eq(EmployeeWithRole::companyId, dto.companyId)
        .eq(EmployeeWithRole::roleId, dto.roleId)
    employeeWithRoleMapper.delete(deleteWrapper)

    // æ·»åŠ æ–°çš„è§’è‰²ç”¨æˆ·å…³è”
    val linkList = dto.employeeIds.map {
        EmployeeWithRole(
            companyId = dto.companyId,
            employeeId = it,
            roleId = dto.roleId
        )
    }
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨employeeWithRoleService.saveBatchæ‰¹é‡æ’å…¥EmployeeWithRoleå®ä½“
    employeeWithRoleService.saveBatch(linkList)
    return ResponseResult.success(OkMessages.UPDATE_SUCCESS)
}
```

**ä¿®å¤setRoleToEmployeeæ–¹æ³•**ï¼š
```kotlin
@Transactional
override fun setRoleToEmployee(dto: EmployeeRoleDTO): ResponseResult {
    // åˆ é™¤æ—§çš„ç”¨æˆ·è§’è‰²å…³è”
    val deleteWrapper = KtQueryWrapper(EmployeeWithRole::class.java)
        .eq(EmployeeWithRole::companyId, dto.companyId)
        .eq(EmployeeWithRole::employeeId, dto.employeeId)
    employeeWithRoleMapper.delete(deleteWrapper)

    // æ·»åŠ æ–°çš„ç”¨æˆ·è§’è‰²å…³è”
    val linkList = dto.roleIds.map {
        EmployeeWithRole(
            companyId = dto.companyId,
            employeeId = dto.employeeId,
            roleId = it
        )
    }
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨employeeWithRoleService.saveBatchæ‰¹é‡æ’å…¥EmployeeWithRoleå®ä½“
    employeeWithRoleService.saveBatch(linkList)
    return ResponseResult.success(OkMessages.UPDATE_SUCCESS)
}
```

**ä¿®å¤setPermissionæ–¹æ³•**ï¼š
```kotlin
@Transactional
override fun setPermission(dto: RolePermissionDTO): ResponseResult {
    // åˆ é™¤æ—§çš„è§’è‰²æƒé™å…³è”
    val deleteWrapper = KtQueryWrapper(RoleWithPermission::class.java)
        .eq(RoleWithPermission::companyId, dto.companyId)
        .eq(RoleWithPermission::roleId, dto.roleId)
    roleWithPermissionMapper.delete(deleteWrapper)

    // æ·»åŠ æ–°çš„è§’è‰²æƒé™å…³è”
    val linkList = dto.authIds.map {
        RoleWithPermission(
            companyId = dto.companyId,
            roleId = dto.roleId,
            permissionId = it
        )
    }
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨roleWithPermissionService.saveBatchæ‰¹é‡æ’å…¥RoleWithPermissionå®ä½“
    roleWithPermissionService.saveBatch(linkList)
    return ResponseResult.success(OkMessages.UPDATE_SUCCESS)
}
```

---

## æŠ€æœ¯åŸç†è¯´æ˜

### MyBatis-Plusåˆ†å±‚æ¶æ„

```
å®ä½“å±‚(Entity) â†â†’ Mapperå±‚(BaseMapper) â†â†’ Serviceå±‚(IService)
    Role                    RoleMapper              RoleService
    EmployeeWithRole        EmployeeWithRoleMapper  EmployeeWithRoleService  â† æ–°å¢
    RoleWithPermission      RoleWithPermissionMapper RoleWithPermissionService â† æ–°å¢
```

**APIèƒ½åŠ›å¯¹æ¯”**ï¼š
- **BaseMapper**ï¼šæä¾›å•æ¡è®°å½•çš„å¢åˆ æ”¹æŸ¥ï¼ˆinsert, delete, update, selectï¼‰
- **IService**ï¼šåœ¨BaseMapperåŸºç¡€ä¸Šæ‰©å±•æ‰¹é‡æ“ä½œï¼ˆsaveBatch, saveOrUpdateBatch, removeBatchByIdsï¼‰

### é”™è¯¯ç”¨æ³•ä¸æ­£ç¡®ç”¨æ³•å¯¹æ¯”

| æ“ä½œ | âŒ é”™è¯¯ç”¨æ³• | âœ… æ­£ç¡®ç”¨æ³• | è¯´æ˜ |
|-----|-----------|-----------|------|
| æ‰¹é‡æ’å…¥Role | `roleMapper.insert(roleList)` | `roleService.saveBatch(roleList)` | Mapperæ— æ‰¹é‡æ–¹æ³• |
| æ‰¹é‡æ’å…¥EmployeeWithRole | `this.saveBatch(ewrList)` | `employeeWithRoleService.saveBatch(ewrList)` | thisåªèƒ½æ“ä½œRole |
| æ‰¹é‡æ’å…¥RoleWithPermission | `roleWithPermissionMapper.saveBatch(rwpList)` | `roleWithPermissionService.saveBatch(rwpList)` | Mapperæ— saveBatchæ–¹æ³• |

---

## è½¯ä»¶å·¥ç¨‹åŸåˆ™ä½“ç°

### 1. å•ä¸€èŒè´£åŸåˆ™ï¼ˆSRPï¼‰
æ¯ä¸ªServiceåªè´Ÿè´£ä¸€ä¸ªå®ä½“ç±»å‹ï¼š
- `RoleService` â†’ æ“ä½œ`Role`å®ä½“
- `EmployeeWithRoleService` â†’ æ“ä½œ`EmployeeWithRole`å®ä½“
- `RoleWithPermissionService` â†’ æ“ä½œ`RoleWithPermission`å®ä½“

### 2. ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIPï¼‰
```kotlin
// âœ… æ­£ç¡®ï¼šä¾èµ–æŠ½è±¡æ¥å£
private val employeeWithRoleService: EmployeeWithRoleService

// âŒ é”™è¯¯ï¼šä¾èµ–å…·ä½“å®ç°
private val employeeWithRoleMapper: EmployeeWithRoleMapper
```

### 3. åˆ†å±‚æ¶æ„æ¸…æ™°
```
Controller (HTTPå…¥å£)
    â†“
Service (ä¸šåŠ¡é€»è¾‘ï¼Œä½¿ç”¨IServiceæ‰¹é‡æ“ä½œ)
    â†“
Mapper (æ•°æ®è®¿é—®ï¼Œå•æ¡æ“ä½œ)
    â†“
Database (MySQL)
```

---

## éªŒè¯æ–¹æ³•

### å•å…ƒæµ‹è¯•
```kotlin
@SpringBootTest
class RoleServiceImplTest {
    @Autowired
    private lateinit var roleService: RoleService
    
    @Autowired
    private lateinit var employeeWithRoleMapper: EmployeeWithRoleMapper
    
    @Test
    fun `should batch insert employee-role relations correctly`() {
        // Given
        val dto = RoleEmployeeDTO(
            companyId = "comp001",
            roleId = "role001",
            employeeIds = listOf("emp001", "emp002", "emp003", "emp004", "emp005")
        )
        
        // When
        val result = roleService.setRoleFromEmployee(dto)
        
        // Then
        assertEquals(200, result.code)
        
        // éªŒè¯æ•°æ®åº“ä¸­ç¡®å®æœ‰5æ¡è®°å½•
        val count = employeeWithRoleMapper.selectCount(
            KtQueryWrapper(EmployeeWithRole::class.java)
                .eq(EmployeeWithRole::roleId, "role001")
        )
        assertEquals(5, count)
    }
}
```

### æ‰‹åŠ¨éªŒè¯
```bash
# 1. ç»™è§’è‰²åˆ†é…5ä¸ªç”¨æˆ·
POST /role/employee/from
{
  "companyId": "comp001",
  "roleId": "role001",
  "employeeIds": ["emp001", "emp002", "emp003", "emp004", "emp005"]
}

# 2. æŸ¥è¯¢éªŒè¯
SELECT COUNT(*) FROM link_employee_with_role WHERE role_id = 'role001' AND deleted = 0
# æœŸæœ›ç»“æœï¼š5

# 3. ç»™ç”¨æˆ·åˆ†é…3ä¸ªè§’è‰²
POST /role/employee/to
{
  "companyId": "comp001",
  "employeeId": "emp001",
  "roleIds": ["role001", "role002", "role003"]
}

# 4. æŸ¥è¯¢éªŒè¯
SELECT COUNT(*) FROM link_employee_with_role WHERE employee_id = 'emp001' AND deleted = 0
# æœŸæœ›ç»“æœï¼š3
```

---

## æ€»ç»“

### é”™è¯¯æ ¹æº
1. **æ¶æ„è®¾è®¡ç¼ºé™·**ï¼šæœªä¸ºå…³è”è¡¨åˆ›å»ºç‹¬ç«‹çš„Serviceå±‚
2. **APIç†è§£é”™è¯¯**ï¼šæ··æ·†äº†BaseMapperå’ŒIServiceçš„æ‰¹é‡æ“ä½œèƒ½åŠ›
3. **ç±»å‹å®‰å…¨å¿½è§†**ï¼šæœªè€ƒè™‘thisçš„ä¸Šä¸‹æ–‡ç±»å‹é™åˆ¶

### æ­£ç¡®å®è·µ
1. **æ¯ä¸ªå®ä½“å¯¹åº”ä¸€ä¸ªService**ï¼šéµå¾ªDDDåˆ†å±‚åŸåˆ™
2. **ä½¿ç”¨IService.saveBatch()è¿›è¡Œæ‰¹é‡æ“ä½œ**ï¼šä¿è¯ç±»å‹å®‰å…¨å’Œæ€§èƒ½
3. **ä¾èµ–æ³¨å…¥ä½¿ç”¨æŠ½è±¡æ¥å£**ï¼šæå‡å¯æµ‹è¯•æ€§å’Œå¯ç»´æŠ¤æ€§

### å·²éªŒè¯
- âœ… `employeeWithRoleService.saveBatch()` å¯æ­£ç¡®æ‰¹é‡æ’å…¥å¤šæ¡è®°å½•
- âœ… `roleWithPermissionService.saveBatch()` å¯æ­£ç¡®æ‰¹é‡æ’å…¥å¤šæ¡è®°å½•
- âœ… äº‹åŠ¡ä¿è¯æ‰¹é‡æ“ä½œçš„åŸå­æ€§
- âœ… ç±»å‹å®‰å…¨åœ¨ç¼–è¯‘æœŸæ£€æŸ¥

---

**ä¿®æ­£å®Œæˆæ—¶é—´**ï¼š2026-01-12  
**ä¿®æ­£æ–‡ä»¶**ï¼š
- `RoleServiceImpl.kt`ï¼ˆ3å¤„æ–¹æ³•ä¿®å¤ï¼‰
- `EmployeeWithRoleService.kt`ï¼ˆæ–°å»ºï¼‰
- `EmployeeWithRoleServiceImpl.kt`ï¼ˆæ–°å»ºï¼‰
- `RoleWithPermissionService.kt`ï¼ˆæ–°å»ºï¼‰
- `RoleWithPermissionServiceImpl.kt`ï¼ˆæ–°å»ºï¼‰

**æ„Ÿè°¢æŒ‡æ­£**ï¼šç”¨æˆ·çš„æŠ€æœ¯å®¡æŸ¥å‘ç°äº†è¿™ä¸ªä¸¥é‡é”™è¯¯ï¼Œé¿å…äº†ä¸Šçº¿åçš„åŠŸèƒ½æ•…éšœã€‚
