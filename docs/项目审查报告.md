# 项目代码审查报告

## 审查概览
- **审查日期**: 2026年1月12日
- **项目位置**: d:/Data/wuzhi
- **前端技术栈**: Vue3 + TypeScript + Element Plus
- **后端技术栈**: Kotlin + Spring Boot + MyBatis-Plus
- **数据库**: MySQL + Redis（向量存储）

## 审查范围
- 前端：Web/src 目录下所有API调用、工具类、页面组件
- 后端：Server/src/main/kotlin 目录下所有Controller、Service、Mapper

## 接口级别逻辑问题

### 一、认证授权模块（/auth）

#### 1.1 发送验证码接口
- **接口路径**: `POST /auth/captcha`
- **前端文件**: `Web/src/Api/AuthApi.ts:25`
- **后端文件**: `Server/src/main/kotlin/com/wuzhi/server/service_user/service/impl/AuthServiceImpl.kt:87`
- **问题描述**: **功能未实现**
  - 后端直接返回成功，未实际发送验证码
  - 前端缺少验证码输入和验证逻辑
  - 注册时要求输入验证码但未实际校验
- **严重程度**: 🔴 严重（导致注册功能不可用）
- **影响**: 用户注册缺少安全保障，形同虚设

#### 1.2 Token刷新机制
- **接口路径**: `POST /auth/refresh`
- **前端文件**: `Web/src/Util/AxiosUtil.ts:130`
- **后端文件**: `Server/src/main/kotlin/com/wuzhi/server/service_user/service/impl/AuthServiceImpl.kt:93`
- **问题描述**: 
  - 前端使用原生axios发送请求，但缺少refreshToken的持久化存储
  - 刷新失败时状态码不一致（后端返回491，前端判断431）
  - 缺少refreshToken过期处理机制
- **严重程度**: 🟡 中等（影响用户体验）

### 二、聊天对话模块（/chat）

#### 2.1 发送消息接口
- **接口路径**: `POST /chat/message/call`
- **前端文件**: `Web/src/Api/ChatApi.ts:9`
- **后端文件**: `Server/src/main/kotlin/com/wuzhi/server/service_chat/service/impl/ChatServiceImpl.kt:96`
- **问题描述**: 
  - **多模态文件处理未完成**（TODO标记）
  - 文件上传后未保存到本地，直接传递给AI服务
  - 缺少文件大小、格式验证
  - 对话ID为空时未自动创建会话
- **严重程度**: 🔴 严重（文件功能不可用）

#### 2.2 AI模型切换问题
- **配置文件**: `Server/src/main/resources/application.yaml:22-35`
- **问题描述**: 
  - API密钥硬编码在配置文件中（sk-开头的明文密钥）
  - 模型名称和配置写死，无法动态切换
  - 缺少模型可用性检测
- **严重程度**: 🔴 严重（生产环境安全隐患）

### 三、知识库模块（/database）

#### 3.1 添加数据库接口
- **接口路径**: `POST /database/add`
- **前端文件**: `Web/src/Api/DatabaseApi.ts:20`
- **后端文件**: `Server/src/main/kotlin/com/wuzhi/server/service_tool/service/impl/DatabaseServiceImpl.kt:59`
- **问题描述**: 
  - URL类型数据库未实现（`TODO("还没做")`）
  - 文件类型数据库缺少重复性检查
  - 大文件上传没有分片机制，可能导致内存溢出
  - 缺少文件类型白名单验证
- **严重程度**: 🟡 中等（部分功能不可用）

#### 3.2 删除数据库节点接口
- **接口路径**: `DELETE /database/delete/node/{id}`
- **后端文件**: `Server/src/main/kotlin/com/wuzhi/server/service_tool/service/impl/DatabaseServiceImpl.kt:169`
- **问题描述**: 
  - **级联删除验证缺失**：删除节点未校验是否存在子节点
  - 直接物理删除，未进行逻辑删除
  - 未删除关联的向量库数据
- **严重程度**: 🔴 严重（数据完整性风险）

### 四、工具管理模块（/tool）

#### 4.1 工具使用接口
- **接口路径**: `POST /tool/use/use`
- **前端文件**: `Web/src/Api/ToolApi.ts:79`
- **问题描述**: 
  - 接口已定义但后端未实现对应的Controller方法
  - 缺少工具使用权限验证
  - 没有使用记录和次数限制
- **严重程度**: 🔴 严重（功能缺失）

#### 4.2 工具删除接口
- **接口路径**: `DELETE /tool/delete/{id}`
- **后端文件**: `Server/src/main/kotlin/com/wuzhi/server/service_tool/service/impl/ToolServiceImpl.kt`
- **问题描述**: 
  - 缺少删除前验证（是否有关联的使用记录、购买记录）
  - 未进行逻辑删除，直接物理删除
- **严重程度**: 🟡 中等（数据完整性风险）

### 五、公司管理模块（/company）

#### 5.1 删除公司接口
- **接口路径**: `POST /company/delete`
- **后端文件**: `Server/src/main/kotlin/com/wuzhi/server/service_company/service/impl/CompanyServiceImpl.kt:214`
- **问题描述**: 
  - **级联删除不完整**：删除了员工和角色关联，但未删除部门、任务、操作记录
  - 缺少事务保护，部分删除失败会导致数据不一致
  - 未检查公司下是否还有活跃员工
- **严重程度**: 🔴 严重（严重数据完整性问题）

#### 5.2 添加公司接口
- **接口路径**: `POST /company/add`
- **后端文件**: `Server/src/main/kotlin/com/wuzhi/server/service_company/service/impl/CompanyServiceImpl.kt:111`
- **问题描述**: 
  - 缺少参数验证（手机号格式、邮箱格式）
  - 未验证用户是否已拥有其他公司
  - 自动创建的部门名与公司名相同，可能导致混淆
- **严重程度**: 🟡 中等

### 六、员工管理模块（/employee）

#### 6.1 添加员工接口
- **接口路径**: `POST /employee/add`
- **后端文件**: `Server/src/main/kotlin/com/wuzhi/server/service_company/service/impl/EmployeeServiceImpl.kt:73`
- **问题描述**: 
  - 缺少用户是否存在验证（注释掉了）
  - 同一用户可重复添加到同一公司（缺少唯一约束）
  - 未自动创建对应的CompanyNode节点
- **严重程度**: 🟡 中等

#### 6.2 员工详情查询
- **接口路径**: `POST /employee/detail`
- **后端文件**: `Server/src/main/kotlin/com/wuzhi/server/service_company/service/impl/EmployeeServiceImpl.kt:273`
- **问题描述**: 
  - 权限控制缺失：可查询任意公司的员工信息
  - 未验证当前用户是否有权限访问该公司数据
- **严重程度**: 🔴 严重（数据安全问题）

### 七、任务管理模块（/mission）

#### 7.1 AI自动分配任务接口
- **接口路径**: `POST /mission/add/ai`
- **后端文件**: `Server/src/main/kotlin/com/wuzhi/server/service_company/service/impl/MissionServiceImpl.kt`
- **问题描述**: 
  - AI调用逻辑未完成（缺少实现）
  - 缺少任务分配策略配置
  - 未验证部门是否存在和是否有足够资源
- **严重程度**: 🟡 中等（功能未完成）

## 通用问题

### 1. 权限控制缺失
- **问题描述**: 所有接口缺少权限验证（除登录注册外）
- **影响范围**: 所有业务模块
- **严重程度**: 🔴 严重
- **具体表现**: 
  - TokenInterceptor只验证token有效性，不验证权限
  - 缺少RBAC权限模型的实际应用
  - 用户可访问和操作任意公司的数据

### 2. 数据验证缺失
- **问题描述**: 大量接口缺少参数验证
- **影响范围**: 前后端所有模块
- **严重程度**: 🟡 中等
- **具体表现**: 
  - 前端Form表单缺少rules验证
  - 后端DTO缺少@Valid注解验证
  - 未对空值、格式、长度进行校验

### 3. 错误处理不一致
- **问题描述**: 错误处理机制混乱
- **影响范围**: 前后端所有模块
- **严重程度**: 🟡 中等
- **具体表现**: 
  - 前端Axios拦截器对错误处理不完整
  - 后端返回的状态码不一致
  - 缺少统一的错误码规范

### 4. 事务管理问题
- **问题描述**: 事务使用不规范
- **影响范围**: 业务层Service
- **严重程度**: 🟡 中等
- **具体表现**: 
  - 部分需要事务的方法未添加@Transactional
  - 事务范围过大，包含不必要的操作
  - 嵌套事务处理不当

### 5. 代码质量问题
- **TODO标记**: 多处TODO未实现
- **硬编码**: API密钥、配置信息硬编码
- **死代码**: 大量注释掉的代码未清理
- **缺少注释**: 复杂业务逻辑缺少说明

## 性能问题

### 1. N+1查询问题
- **位置**: 员工统计、公司统计等接口
- **问题**: 使用循环查询数据库，未使用批量查询
- **影响**: 数据量大时性能急剧下降

### 2. 内存泄漏风险
- **位置**: 文件上传、向量库处理
- **问题**: 大文件一次性加载到内存，未使用流式处理
- **影响**: 大文件可能导致OOM

### 3. 并发安全问题
- **位置**: Token刷新机制、计数器
- **问题**: 使用非线程安全的数据结构
- **影响**: 高并发下数据不准确

## 安全风险

### 1. 认证安全
- JWT密钥配置在明文配置文件中
- Token有效期过长（7天刷新token）
- 缺少Token黑名单机制

### 2. 数据安全
- 用户可越权访问其他公司数据
- 删除操作未验证数据所有权
- 敏感信息（手机号、邮箱）未脱敏返回

### 3. 注入风险
- MyBatis-Plus使用不当可能存在SQL注入
- 文件上传缺少类型和大小验证

## 修复优先级建议

### 🔴 紧急修复（影响核心功能）
1. 实现验证码发送和验证功能
2. 完善权限控制，限制用户只能访问所属公司数据
3. 修复删除公司时的级联删除问题
4. 移除配置文件中的硬编码密钥
5. 实现多模态文件处理功能

### 🟡 高优先级（影响功能和性能）
1. 统一前后端错误处理机制
2. 完善数据验证和参数校验
3. 修复N+1查询问题
4. 添加事务管理
5. 实现URL类型知识库

### 🟢 中优先级（优化和增强）
1. 清理TODO和死代码
2. 添加接口限流
3. 完善日志记录
4. 添加单元测试
5. 优化前端状态管理

## 总结

项目中存在 **7个严重问题** 和 **15个中等问题**，主要集中在于：

1. **功能不完整**：验证码、AI任务分配、URL知识库等核心功能未实现
2. **权限缺失**：缺少完整的RBAC权限验证机制
3. **数据完整性**：删除操作缺少级联验证和事务保护
4. **安全隐患**：密钥硬编码、越权访问等问题
5. **代码质量**：TODO、硬编码、缺少验证等问题较多

建议优先修复严重问题，确保核心功能可用和数据安全。
